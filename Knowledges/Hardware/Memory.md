# Memory
Linux — это система, основанная на виртуальной памяти, где каждый процесс имеет
свое виртуальное адресное пространство. Она выполняет отображение в физиче-
ские адреса по мере необходимости. Ее дизайн допускает избыточную подписку на
физическую память, которой Linux управляет с помощью демона выгрузки страниц
и физических устройств подкачки, а также имеет компонент ядра Out-Of-Memory
Killer, который останавливает процессы при критической нехватке памяти. Linux
использует свободную память в качестве кэша файловой системы.
![image](https://github.com/user-attachments/assets/c7c30183-5590-4191-a703-c8cfad3a545f)
Процессы, управляющие памятью с по-мощью библиотеки libc, получают память из динамического сегмента виртуального
адресного пространства процесса, который называется кучей (heap). Библиотека
libc предоставляет функции для управления распределением памяти, включая
malloc() и free(). Когда процесс освобождает блок памяти, libc запоминает его
местоположение и использует эту информацию в последующих вызовах malloc().
libc увеличивает размер кучи только после исчерпания доступной памяти. Уменьшать размер кучи обычно не требуется, потому что это виртуальная, а не реальная
физическая память.

За отображение виртуальных адресов в физические отвечает ядро и процессор. Для
эффективности отображение адресов осуществляется группами, или страницами,
где размер каждой страницы зависит от аппаратной архитектуры процессора. 

Ядро может обслуживать запросы на получение страниц физической
памяти из своих собственных списков свободной памяти, которые поддерживает
для каждой группы микросхем ОЗУ (DRAM) и CPU. 
Само ядро тоже потребляет
память из этих списков, обычно используя свой механизм управления памятью —
распределитель блоков (slab allocator).

В числе других библиотек управления памятью в пространстве пользователя можно
назвать tcmalloc и jemalloc. Среды времени выполнения, например JVM, тоже часто
предоставляют свой механизм управления памятью со средствами сборки мусора.
Другие механизмы управления могут также отображать частные сегменты для
распределения памяти вне кучи.

## Страницы памяти и подкачка
1. Приложение запрашивает блок памяти (например, вызывает функцию malloc()
из библиотеки libc).
2. Библиотека может сразу же выделить память из своего списка свободных
страниц или сначала обратиться к системе для увеличения объема доступной
ей виртуальной памяти. В зависимости от ситуации, библиотека:
 - a) увеличит размер кучи обращением к системному вызову brk() и использует
дополнительную полученную память для удовлетворения запроса;
 - b) создаст новый сегмент обращением к системному вызову mmap().
3. Спустя какое-то время приложение может попытаться использовать выделен-
ный диапазон памяти с помощью инструкций записи и чтения, вовлекающих
в работу блок управления памятью (Memory Management Unit, MMU) для пре-
образования виртуальных адресов в физические. И тогда вскрывается ложная
природа виртуальной памяти: виртуальным адресам не соответствует никакая
физическая память! Это приводит к ошибке MMU — сбою страницы (page fault).
4. Сбой страницы обрабатывается ядром, которое устанавливает соответствие
между виртуальными адресами и адресами из своих списков свободных блоков
физической памяти и затем информирует MMU об этом соответствии для ис-
пользования в будущем. Затем процесс использует дополнительную страницу
физической памяти. Такой объем физической памяти называется размером
резидентного набора (Resident Set Size, RSS).
5. С увеличением спроса на память в работу включается демон подкачки (kswapd).
Он отыскивает страницы физической памяти, которые можно освободить или
вытеснить на устройство подкачки. Освободить можно страницы трех типов
(на рис. 7.2 приведен только третий тип (с), так как рисунок иллюстрирует
жизненный цикл страниц памяти в пространстве пользователя):
 - a) страницы файловой системы, которые были прочитаны с диска и не изме-
нялись (их называют «зарезервированными на диске»): их можно удалить
немедленно и при необходимости просто прочитать повторно. Эти страницы
могут хранить выполняемый код приложений, данные и метаданные фай-
ловой системы;
 - b) страницы файловой системы, которые были изменены: это так называемые
«грязные» страницы, которые следует записать на диск перед освобожде-
нием;
 - c) страницы памяти приложения: их называют анонимной памятью, потому
что у них нет источника в файловой системе. Если в системе есть устрой-
ство подкачки, эти страницы можно освободить, предварительно сохранив
на устройстве подкачки. Операция записи страниц на устройство подкачки
называется подкачкой (в Linux).

Запросы на выделение памяти обычно следуют друг за другом очень часто: вы-
деление памяти в пространстве пользователя может происходить миллионы раз
в секунду. Операции чтения и записи, а также поиск соответствий в MMU проис-
ходят еще чаще — до нескольких миллиардов раз в секунду. Другие операции — вызовы brk() и mmap(), сбои страниц и вытеснение страниц — выполняются относительно редко.
