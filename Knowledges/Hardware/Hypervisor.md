# Hypervisor
А - пример Xen, B - пример KVM
![image](https://github.com/user-attachments/assets/21f01258-b3fd-499e-8935-47cf78b41482)

Обе конфигурации могут предусматривать запуск прокси-сервера ввода/вывода
(например, программного обеспечения QEMU) в домене 0 (Xen) или в ОС хоста
(KVM) для обслуживания гостевого ввода/вывода. Это решение увеличивает
оверхед на ввод/вывод, но с годами оно было оптимизировано за счет добавления
транспортов с разделяемой памятью и других технологий.

QEMU - прокси сервер нужный для проброса устройств. <br>
AWS выпустила гипервизор Nitro с компонентами на основе KVM
и аппаратной поддержкой всех основных ресурсов: процессоров, сетевых карт,
хранилищ, прерываний и таймеров. Прокси-сервер QEMU не используется.

HVM - аппаратная виртуализация, Hardware VM. <br>
PV, Paravirtualization - позволяет уведомить гостевую ось что она выполняется в режиме ВМ, что позволяет ей делать специальные гипервызовы, повышающие эффективность работы. <br>
Аппаратная поддержка устройств - в аппаратные устройства добавили поддержку виртуальных машин, сюда входит SR-IOV для сетевых устройств и устройств хранения. <br>
PVHVM - используется аппаратная виртуализация с поддержкой паравиртуализации.

## Типы целевых гипервизоров, которые можно трассировать
 - PV: гипервызовы (мультивызовы), обратные вызовы гипервизора, вызовы
драйверов, недополученное время;
 - PVHVM: обратные вызовы гипервизора, вызовы драйверов, недополученное
время;
 - PVHVM + драйверы SR-IOV: обратные вызовы гипервизора, недополученное
время;
 - KVM (Nitro): недополученное время.
## Возможные стратегии
### На уровне гостевой системы:

1. Инструментируйте гипервызовы (если они есть) для проверки выполнения
избыточных операций.
2. Проверьте недополученное процессорное время.
3. Используйте инструменты bpf, но не забывайте, что это виртуальные ресурсы. Их производительность
может ограничиваться гипервизором или внешним оборудованием и страдать
от конфликтов с другими гостевыми системами.

### На уровне хоста:

1. Инструментируйте выходы из виртуальной машины для проверки выполнения
избыточных операций.
2. Если используется прокси-сервер ввода/вывода (QEMU), измерьте его рабочую
нагрузку и задержку.
3. Примените инструменты из предыдущих глав для анализа потребления ре-
сурсов.

## Традиционные инструменты
Иногда в гостевых системах можно использовать точки трас-
сировки для гипервызовов. <br>
На уровне хоста гипервизор Xen предлагает свои инструменты, включая xl top
и xentrace, для исследования потребления гостевых ресурсов. Для KVM утилита
perf в Linux предоставляет подкоманду kvm.
```
# perf kvm stat live
..
11:12:07.687968
Analyze events for all VMs, all VCPUs:
VM-EXIT         Samples Samples% Time%  Min    Time Max Time   Avg time
MSR_WRITE          1668    68.90%  0.28%  0.67us 31.74us  3.25us ( +- 2.20% )
HLT                466    19.25%  99.63% 2.61us 100512.98us 4160.68us ( +- 14.77% )
PREEMPTION_TIMER   112 4.63% 0.03% 2.53us 10.42us 4.71us ( +- 2.68% )
PENDING_INTERRUPT  82 3.39% 0.01% 0.92us 18.95us 3.44us ( +- 6.23% )
EXTERNAL_INTERRUPT 53 2.19% 0.01% 0.82us 7.46us 3.22us ( +- 6.57% )
IO_INSTRUCTION     37 1.53% 0.04% 5.36us 84.88us 19.97us ( +- 11.87% )
MSR_READ           2 0.08% 0.00% 3.33us 4.80us 4.07us ( +- 18.05% )
EPT_MISCONFIG      1 0.04% 0.00% 19.94us 19.94us 19.94us ( +- 0.00% )

Total Samples:2421, Total events handled time:1946040.48us.
```
Этот вывод показывает причины выхода виртуальной машины в гипервизор и ста-
тистику по каждой причине. Наиболее продолжительные выходы в этом примере
были обусловлены операцией HLT (остановка), выполняя которую виртуальные
процессоры переходят в состояние ожидания.

## ИНСТРУМЕНТЫ BPF ДЛЯ АНАЛИЗА НА УРОВНЕ ГОСТЕВОЙ ОС
### Гипервызовы Xen
Если гостевая система использует паравиртуализацию и выполняет гипервызовы,
их можно трассировать с помощью funccount(8), trace(8), argdist(8) и stackcount(8).
Более того, для Xen есть даже точки трассировки.
### Xen PV
```
# dmesg | grep Hypervisor
[ 0.000000] Hypervisor detected: Xen PV
```
```
# funccount 't:xen:*'
Tracing 30 functions for "t:xen:*"... Hit Ctrl-C to end.
^C
FUNC COUNT
xen:xen_mmu_flush_tlb_one_user 70
xen:xen_mmu_set_pte 84
xen:xen_mmu_set_pte_at 95
xen:xen_mc_callback 97
xen:xen_mc_extend_args 194
xen:xen_mmu_write_cr3 194
xen:xen_mc_entry_alloc 904
xen:xen_mc_entry 924
xen:xen_mc_flush 1175
xen:xen_mc_issue 1378
xen:xen_mc_batch 1392
Detaching...
```
