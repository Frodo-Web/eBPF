
## Disk I/O

Предварительный flow:

App syscalls, page cache, block layer, device drivers, physical disk

Разные планировщики, с разными характеристиками
Scheduler types:
  Classic:
    - Noop
    - Deadline
    - CFQ
  Multiple queue:
    - None
    - BFQ
    - mq-deadline
    - Kyber

ОС: Очередь планировщика и диспетчера ОС (Время ожидания)
Устройство: Дисковые кеш, Очередь ввода/вывода (Время обслуживания)
Время ожидания + Время обслуживания = Время обработки запроса

Попадание в кеш - Завершение, минуя очередь устройства (Промах кеша)

Использвание диска: Кеш, очередь, пропусная способность

Степень загрузки рассчитывается ОС как время в теч которого диск что то делал

Время ожидания позволяет точнее диагностировать проблемы производительности.

Когда могут быть проблемы в очереди планировщика ОС?
Когда очередь сильно заполняется и мы точно знаем диск не до конца утилизирован и с ним нет никаких проблем и ближашими компонентами по флоу.
- Большая глубина очереди (частые запросы от приложения)
- В block layer вырастает задержка перед тем как запрос уйдёт в hardware queue

Пример:
 - Плохая конфигурация или дизайн I/O scheduler при множестве процессов в системе (Как в случае с classic schedulers)
 - Возникает недоступность диска (Поэтому копится очередь в OS)
 - Проблемы оптимизации драйвера

Функции которые можно диагностировать:
 - sys_read(), sys_write() - например можно попробовать ошибки ловить, если приложение при ошибке делает повторные syscalls, это дополнительные расходы
 - generic_make_request, blk_mq_make_request, __elv_add_request
 - Device driver entry points
 - Функции относящиеся к page cache, например filemap_fault для page faults которые могут приводить к росту read I/O

Инструменты:
 - biosnoop - to track individual I/O ops
 - biolatency - for latency distributions
 - blockqslower - to detect delays in the block layer
 - eBPF programs to trace latency of requests in different queues 

Ещё какие могут быть проблемы:
 - Читаемые файлы настолько большие что не помещаются в кэш страниц и читаются непосредственно с диска
